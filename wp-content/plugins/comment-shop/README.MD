# Comment Shop - Extension de T√©moignages Clients

**Version:** 1.0.0  
**Auteur:** Johan PRISO  
**Type:** Plugin WordPress  
**Compatibilit√©:** WordPress 5.8+, WooCommerce 6.0+

---

## üìã Description

**Comment Shop** est une extension WordPress permettant de g√©rer des **t√©moignages clients g√©n√©raux** sur une boutique en ligne. Contrairement aux avis produits natifs de WooCommerce (qui sont li√©s √† un produit sp√©cifique), cette extension cr√©e un syst√®me de t√©moignages **globaux** affichables partout sur le site (homepage, sidebar, footer).

### üéØ Objectif Acad√©mique

Cette extension a √©t√© d√©velopp√©e dans le cadre d'un projet universitaire d√©montrant la ma√Ætrise de :
- Custom Post Types (CPT)
- Syst√®me de hooks WordPress
- Int√©gration WooCommerce
- AJAX et s√©curit√© WordPress
- Architecture MVC-like

---

## üèóÔ∏è Architecture Technique

### Structure des fichiers

```
comment-shop/
‚îú‚îÄ‚îÄ comment-shop.php          # Fichier principal (bootstrap)
‚îú‚îÄ‚îÄ README.md                 # Documentation
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ avis-styles.css   # Styles frontend
‚îÇ   ‚îî‚îÄ‚îÄ js/
‚îÇ       ‚îî‚îÄ‚îÄ avis-ajax.js      # JavaScript (√©toiles + AJAX)
‚îî‚îÄ‚îÄ includes/
    ‚îú‚îÄ‚îÄ class-cpt-avis.php        # Custom Post Type "avis"
    ‚îú‚îÄ‚îÄ class-metaboxes.php       # Champs personnalis√©s admin
    ‚îú‚îÄ‚îÄ class-formulaire.php      # Formulaire frontend + AJAX
    ‚îú‚îÄ‚îÄ class-shortcodes.php      # Shortcodes WordPress
    ‚îî‚îÄ‚îÄ class-widget.php          # Hook footer automatique
```

### Pattern de conception

- **Singleton Pattern** : Chaque classe utilise `get_instance()` pour √©viter les duplications
- **S√©paration des responsabilit√©s** : Chaque classe a un r√¥le unique et d√©fini
- **Hooks WordPress** : Utilisation intensive de `add_action()` et `add_filter()`

---

## ‚öôÔ∏è Fonctionnalit√©s

### 1. Custom Post Type "T√©moignages" ‚úÖ

**Fichier:** `includes/class-cpt-avis.php`

- **Slug:** `avis`
- **Labels:** "üí¨ T√©moignages" dans l'admin WordPress
- **Colonnes admin personnalis√©es:** Client, Note, Email, Date
- **URL publique:** `/temoignages/` (archive), `/temoignages/nom-temoignage/` (single)

**M√©tadonn√©es (postmeta) :**
- `_avis_email` : Email du client
- `_avis_rating` : Note sur 5 √©toiles (1-5)
- `_avis_product_id` : Optionnel, pour lier √† un produit
- `_avis_user_id` : Optionnel, ID utilisateur WordPress

**Code cl√© :**
```php
register_post_type('avis', array(
    'labels' => [...],
    'public' => true,
    'has_archive' => true,
    'supports' => array('title', 'editor'),
    'menu_icon' => 'dashicons-format-chat',
    'rewrite' => array('slug' => 'temoignages')
));
```

---

### 2. Hook WordPress (wp_footer) ‚úÖ

**Fichier:** `includes/class-widget.php`

**Action hook utilis√©:** `wp_footer`

**Fonctionnalit√© :**
Affiche automatiquement un bandeau violet en bas de toutes les pages du site avec un t√©moignage al√©atoire 4-5‚òÖ.

**Code cl√© :**
```php
add_action('wp_footer', array($this, 'afficher_temoignage_footer'));
```

**Requ√™te WP_Query :**
```php
$avis = get_posts(array(
    'post_type' => 'avis',
    'posts_per_page' => 1,
    'orderby' => 'rand',
    'meta_query' => array(
        array(
            'key' => '_avis_rating',
            'value' => 4,
            'compare' => '>=',
            'type' => 'NUMERIC'
        )
    )
));
```

**R√©sultat visuel :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üí¨ Ce que disent nos clients          ‚îÇ
‚îÇ ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê                              ‚îÇ
‚îÇ "Excellente boutique, je recommande!" ‚îÇ
‚îÇ ‚Äî Marie                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 3. Shortcodes WordPress ‚úÖ

**Fichier:** `includes/class-shortcodes.php`

#### a) `[derniers_avis]`

Affiche une liste des t√©moignages r√©cents.

**Param√®tres :**
- `limit` : Nombre de t√©moignages (d√©faut: 5)

**Utilisation :**
```
[derniers_avis limit="10"]
```

**Code PHP :**
```php
add_shortcode('derniers_avis', array($this, 'afficher_derniers_avis'));
```

#### b) `[note_moyenne]`

Affiche la note moyenne globale de satisfaction (toute la boutique).

**Utilisation :**
```
[note_moyenne]
```

**Affichage :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4.8/5 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê              ‚îÇ
‚îÇ Bas√© sur 12 t√©moignages      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### c) `[formulaire_avis]`

Affiche le formulaire de soumission de t√©moignage.

**Utilisation :**
```
[formulaire_avis]
```

**Fonctionnalit√©s :**
- Syst√®me d'√©toiles cliquables (JavaScript)
- Soumission AJAX (sans rechargement)
- Validation client + serveur
- S√©curit√© : nonces WordPress

---

### 4. Metaboxes WordPress ‚úÖ

**Fichier:** `includes/class-metaboxes.php`

Interface admin pour saisir les m√©tadonn√©es d'un t√©moignage :

- Email du client
- Note (1-5 √©toiles)
- ID produit (optionnel)
- ID utilisateur (optionnel)

**Hook utilis√© :**
```php
add_action('add_meta_boxes', array($this, 'add_metaboxes'));
add_action('save_post_avis', array($this, 'save_metabox_data'));
```

**S√©curit√© :**
- Nonce verification : `wp_verify_nonce()`
- Sanitization : `sanitize_email()`, `intval()`
- Capability check : `current_user_can('edit_post')`

---

### 5. Formulaire Frontend + AJAX ‚úÖ

**Fichier:** `includes/class-formulaire.php`

#### Affichage (Shortcode)
```php
add_shortcode('formulaire_avis', array($this, 'afficher_formulaire'));
```

#### Traitement AJAX
```php
add_action('wp_ajax_submit_avis', array($this, 'traiter_soumission_ajax'));
add_action('wp_ajax_nopriv_submit_avis', array($this, 'traiter_soumission_ajax'));
```

**S√©curit√© AJAX :**
```php
check_ajax_referer('cs_ajax_nonce', 'nonce');
$name = sanitize_text_field($_POST['client_name']);
$email = sanitize_email($_POST['client_email']);
$rating = intval($_POST['rating']);
$content = sanitize_textarea_field($_POST['avis_content']);
```

**R√©ponse JSON :**
```php
wp_send_json_success(array(
    'message' => 'Votre t√©moignage a √©t√© soumis avec succ√®s !',
    'post_id' => $post_id
));
```

---

## üé® Assets Frontend

### CSS (`assets/css/avis-styles.css`)

**270 lignes** de styles organis√©s :

1. **Variables CSS** : Couleurs r√©utilisables
2. **Shortcode [derniers_avis]** : Cartes t√©moignages avec hover
3. **Shortcode [note_moyenne]** : Badge avec √©toiles
4. **Formulaire** : Design moderne avec gradients
5. **√âtoiles interactives** : Transitions et hover effects
6. **Footer widget** : Bandeau violet avec d√©grad√©
7. **Responsive** : Mobile-friendly (@media queries)
8. **Animations** : fadeIn, translateX

**Chargement WordPress :**
```php
wp_enqueue_style('comment-shop-style', CS_PLUGIN_URL . 'assets/css/avis-styles.css', array(), CS_VERSION);
```

### JavaScript (`assets/js/avis-ajax.js`)

**125 lignes** de code jQuery :

1. **Syst√®me d'√©toiles cliquables** :
   - Click ‚Üí Coloration + radio check
   - Hover ‚Üí Preview temporaire
   - Labels dynamiques ("Excellent", "Bien"...)

2. **Soumission AJAX** :
   - `preventDefault()` pour √©viter rechargement
   - Validation c√¥t√© client
   - `$.ajax()` vers `admin-ajax.php`
   - Messages succ√®s/erreur dynamiques
   - Reset formulaire apr√®s succ√®s

**Chargement WordPress :**
```php
wp_enqueue_script('comment-shop-ajax', CS_PLUGIN_URL . 'assets/js/avis-ajax.js', array('jquery'), CS_VERSION, true);

wp_localize_script('comment-shop-ajax', 'commentShopAjax', array(
    'ajaxurl' => admin_url('admin-ajax.php'),
    'nonce' => wp_create_nonce('cs_ajax_nonce')
));
```

---

## üîí S√©curit√© WordPress

### Nonces (CSRF Protection)

**Formulaire :**
```php
wp_nonce_field('submit_avis_nonce', 'avis_nonce');
```

**V√©rification :**
```php
wp_verify_nonce($_POST['avis_nonce'], 'submit_avis_nonce');
```

**AJAX :**
```php
check_ajax_referer('cs_ajax_nonce', 'nonce');
```

### Sanitization (XSS Protection)

- `sanitize_text_field()` : Textes courts
- `sanitize_email()` : Emails
- `sanitize_textarea_field()` : Contenu long
- `intval()` : Nombres
- `esc_html()` : Affichage HTML
- `esc_attr()` : Attributs HTML
- `esc_url()` : URLs

### Validation

```php
if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    return 'Email invalide';
}

if ($rating < 1 || $rating > 5) {
    return 'Note invalide';
}
```

---

## üìä Base de donn√©es

### Tables utilis√©es

1. **wp_posts** : Stockage des t√©moignages (CPT)
   - `post_type = 'avis'`
   - `post_title` = Titre/nom client
   - `post_content` = T√©moignage complet
   - `post_status` = 'publish' / 'draft'

2. **wp_postmeta** : M√©tadonn√©es
   - `_avis_email`
   - `_avis_rating`
   - `_avis_product_id`
   - `_avis_user_id`

### Requ√™tes SQL (via WP_Query)

**T√©moignages r√©cents :**
```php
get_posts(array(
    'post_type' => 'avis',
    'posts_per_page' => 5,
    'orderby' => 'date',
    'order' => 'DESC'
));
```

**Note moyenne globale :**
```php
$avis = get_posts(array('post_type' => 'avis', 'posts_per_page' => -1));
foreach ($avis as $item) {
    $total += get_post_meta($item->ID, '_avis_rating', true);
}
$moyenne = $total / count($avis);
```

---

## üöÄ Installation

### Pr√©requis

- WordPress 5.8+
- PHP 7.4+
- WooCommerce (optionnel mais recommand√©)

### √âtapes

1. **T√©l√©charger l'extension**
   ```bash
   cd wp-content/plugins/
   git clone [repo-url] comment-shop
   ```

2. **Activer dans WordPress**
   - Admin ‚Üí Extensions ‚Üí Activer "Comment Shop"

3. **Flush rewrite rules**
   - Admin ‚Üí R√©glages ‚Üí Permaliens ‚Üí Enregistrer

4. **Cr√©er des t√©moignages**
   - Admin ‚Üí üí¨ T√©moignages ‚Üí Ajouter

5. **Utiliser les shortcodes**
   - Cr√©er page "T√©moignages"
   - Ajouter `[derniers_avis limit="10"]`

---

## üìù Utilisation

### Sc√©nario 1 : Page t√©moignages

**Cr√©er :** Admin ‚Üí Pages ‚Üí Ajouter

**Contenu :**
```
[note_moyenne]

[derniers_avis limit="15"]
```

**R√©sultat :** Liste compl√®te des t√©moignages avec note globale

---

### Sc√©nario 2 : Formulaire de soumission

**Cr√©er :** Admin ‚Üí Pages ‚Üí Ajouter (Titre: "Laisser un t√©moignage")

**Contenu :**
```
Vous √™tes satisfait de votre achat ? Partagez votre exp√©rience !

[formulaire_avis]
```

**R√©sultat :** Formulaire interactif avec √©toiles cliquables

---

### Sc√©nario 3 : Widget footer automatique

**Rien √† faire !** Le hook `wp_footer` affiche automatiquement un t√©moignage al√©atoire en bas de chaque page.

---

## üîÑ Diff√©rence avec WooCommerce

| **Avis WooCommerce** | **T√©moignages Comment Shop** |
|---------------------|------------------------------|
| Type : Commentaires WordPress | Type : Custom Post Type |
| Table : `wp_comments` | Table : `wp_posts` |
| Li√© √† UN produit (obligatoire) | T√©moignages g√©n√©raux (optionnel produit) |
| Affich√© sur page produit uniquement | Affichable PARTOUT (shortcodes) |
| Pas de hook automatique | Hook footer automatique |
| Interface admin standard | Interface admin d√©di√©e |
| Objectif : √âvaluer CE produit | Objectif : Cr√©dibilit√© GLOBALE |

**Analogie :**
- **WooCommerce** = Amazon (avis produits sp√©cifiques)
- **Comment Shop** = Trustpilot (satisfaction globale boutique)

---

## üéì Concepts WordPress d√©montr√©s

### 1. Custom Post Types
```php
register_post_type('avis', [...]);
```

### 2. Hooks (Actions & Filters)
```php
add_action('wp_footer', [...]);
add_filter('manage_avis_posts_columns', [...]);
```

### 3. Shortcodes
```php
add_shortcode('derniers_avis', [...]);
```

### 4. AJAX WordPress
```php
add_action('wp_ajax_submit_avis', [...]);
add_action('wp_ajax_nopriv_submit_avis', [...]);
```

### 5. Metaboxes
```php
add_meta_box('avis_details', [...]);
```

### 6. Enqueue Scripts/Styles
```php
wp_enqueue_style('comment-shop-style', [...]);
wp_enqueue_script('comment-shop-ajax', [...]);
wp_localize_script('comment-shop-ajax', [...]);
```

### 7. S√©curit√©
- Nonces (`wp_nonce_field`, `wp_verify_nonce`)
- Sanitization (`sanitize_*`)
- Validation (`filter_var`)
- Capability checks (`current_user_can`)

### 8. Singleton Pattern
```php
private static $instance = null;
public static function get_instance() { [...] }
```

---

## üìà Statistiques

- **Fichiers PHP :** 6
- **Lignes de code PHP :** ~850
- **Lignes CSS :** ~270
- **Lignes JavaScript :** ~125
- **Total :** ~1245 lignes

**R√©partition :**
- CPT : 128 lignes
- Metaboxes : 151 lignes
- Formulaire : 234 lignes
- Shortcodes : 125 lignes (apr√®s simplification)
- Widget : 115 lignes
- Assets : 395 lignes

---

## üêõ D√©bogage

### Activer le mode debug WordPress

**wp-config.php :**
```php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
define('WP_DEBUG_DISPLAY', false);
```

**Logs :** `wp-content/debug.log`

### V√©rifier les hooks

**Plugin recommand√© :** Query Monitor

### Tester AJAX

**Console navigateur :**
```javascript
console.log(commentShopAjax.ajaxurl);
console.log(commentShopAjax.nonce);
```

---

## üìö Documentation WordPress utilis√©e

- [Plugin Handbook](https://developer.wordpress.org/plugins/)
- [Custom Post Types](https://developer.wordpress.org/plugins/post-types/)
- [Shortcode API](https://codex.wordpress.org/Shortcode_API)
- [AJAX in Plugins](https://codex.wordpress.org/AJAX_in_Plugins)
- [Metadata API](https://developer.wordpress.org/plugins/metadata/)

---

## ü§ù Contribution

**Auteur principal :** Johan PRISO  
**Projet acad√©mique** : WordPress + WooCommerce  
**Date :** D√©cembre 2024

---

## üìÑ Licence

Ce projet est d√©velopp√© dans un cadre √©ducatif.

---

## ‚úÖ Checklist Projet Acad√©mique

- [x] **1 Custom Post Type** : "avis" (t√©moignages)
- [x] **1 Hook minimum** : `wp_footer` (widget automatique)
- [x] **Architecture propre** : Classes s√©par√©es, Singleton pattern
- [x] **S√©curit√©** : Nonces, sanitization, validation
- [x] **AJAX** : Soumission formulaire sans rechargement (bonus)
- [x] **Assets** : CSS + JavaScript optimis√©s
- [x] **Documentation** : README complet
- [x] **Fonctionnel** : Test√© et op√©rationnel

---

**üéâ Extension pr√™te pour √©valuation acad√©mique !**
